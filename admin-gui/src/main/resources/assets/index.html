<!doctype html>
<html lang="en" ng-app="adminApp">
<head>
    <meta charset="utf-8">
    <title>HAAS Admin</title>

    <link rel="stylesheet" href="webjars/angular-material/1.0.5/angular-material.min.css">

    <script src="webjars/angularjs/1.4.9/angular.min.js"></script>

    <script src="webjars/angularjs/1.4.9/angular-route.min.js"></script>

    <script src="webjars/angularjs/1.4.9/angular-animate.min.js"></script>
    <script src="webjars/angularjs/1.4.9/angular-aria.min.js"></script>
    <script src="webjars/angularjs/1.4.9/angular-animate.min.js"></script>
    <script src="webjars/angularjs/1.4.9/angular-messages.min.js"></script>

    <script src="webjars/angular-material/1.0.5/angular-material.js"></script>

    <script src="webjars/jquery/3.0.0-alpha1/jquery.min.js"></script>

    <script src="webjars/lodash/4.0.0/lodash.min.js"></script>

    <style type="text/css">
        .layout-margin {
            margin: 4px;
        }

        html, body {
            height: 100%;
            margin: 0;
        }

        #wrapper {
            min-height: 100%;
        }
    </style>

    <script type="text/javascript">
        var adminApp = angular.module('adminApp', ['ngMaterial', 'ngRoute']);

        adminApp.config(['$routeProvider', function ($routeProvider) {
            $routeProvider.
                    when('/entrypoints', {
                        templateUrl: 'partials/entrypoints.html',
                        controller: 'EntrypointsCtrl'
                    }).
                    otherwise({
                        redirectTo: '/entrypoints'
                    })
        }]);

        adminApp.controller('EntrypointsCtrl', function ($scope, $http, $interval) {

            $http({
                method: 'GET',
                url: '/api/entrypoints'
            }).then(function (response) {
                $scope.entrypoints = response.data;
            });

            $scope.loadEntrypoint = function (id) {
                $scope.selectedEntrypoint = id;
            }

        });

        adminApp.directive('entrypointView', ['$interval', '$timeout', '$http', '$q',
            function ($interval, $timeout, $http, $q) {
                return {
                    restrict: 'E',
                    templateUrl: 'partials/entrypoint-view.html',
                    scope: {
                        id: '=id'
                    },
                    link: function (scope, element, attrs) {
                        reloadDelay = 3000;
                        blinkingDelay = 3000;
                        autoRefresh = false;
                        blinking = false;

                        refreshAllStates = function () {
                            return $q.all([
                                $http.get('/api/entrypoint/' + scope.id + '/current')
                                        .then(function (response) {
                                            scope.current = response.data;
                                        }, function (error) {
                                            //TODO Check for 404
                                            scope.current = undefined
                                        }),
                                $http.get('/api/entrypoint/' + scope.id + '/pending')
                                        .then(function (response) {
                                            scope.pending = response.data;
                                        }, function (error) {
                                            //TODO Check for 404
                                            scope.pending = undefined
                                        }),
                                $http.get('/api/entrypoint/' + scope.id + '/committing')
                                        .then(function (response) {
                                            scope.committing = response.data;
                                        }, function (error) {
                                            //TODO Check for 404
                                            scope.committing = undefined
                                        })
                            ])
                        };

                        /* When id is changed, we must reload the data */
                        scope.$watch('id', function (newValue, oldValue) {
                            autoRefresh = false;
                            blinking = false;
                            refreshAllStates().then(function () {
                                autoRefresh = true;
                                blinking = true;
                            });
                        });

                        refreshAuto = $interval(function () {
                            if (scope.id && autoRefresh) {
                                refreshAllStates();
                            }
                        }, reloadDelay);

                        /* Make tab blink while something is committing */
                        scope.$watch('committing', function (newValue, oldValue) {
                            if (blinking) {
                                scope.commitBlink = (newValue != undefined);
                            }
                        }, true);

                        /* Make tab blink several seconds when new pending */
                        scope.$watch('pending', function (newValue, oldValue) {
                            if (blinking) {
                                scope.pendingBlink = true;
                                $timeout(function () {
                                    scope.pendingBlink = false;
                                }, blinkingDelay);
                            }
                        }, true);

                        /* Make tab blink several seconds when new current */
                        scope.$watch('current', function (newValue, oldValue) {
                            if (blinking) {
                                scope.currentBlink = true;
                                $timeout(function () {
                                    scope.currentBlink = false;
                                }, blinkingDelay);
                            }
                        }, true);

                        scope.$on('$destroy', function () {
                            $interval.cancel(refreshAuto);
                        });
                    }
                }
            }])
        ;

    </script>
</head>
<body>
<div id="wrapper" layout="column">
    <div>
        <md-content>
            <md-toolbar>
                <div class="md-toolbar-tools">
                    <h2>
                        <span>HAProxy As A Service</span>
                    </h2>
                </div>
            </md-toolbar>
        </md-content>
    </div>
    <div ng-view layout flex>
    </div>
    <div>
        <md-content>
            <md-toolbar>
                <div class="md-toolbar-tools">
                </div>
            </md-toolbar>
        </md-content>
    </div>
</div>
</body>
</html>