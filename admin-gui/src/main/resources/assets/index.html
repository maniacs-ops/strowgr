<!doctype html>
<html lang="en" ng-app="adminApp">
<head>
    <meta charset="utf-8">
    <title>HAAS Admin</title>

    <link rel="stylesheet" href="webjars/angular-material/1.0.5/angular-material.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script src="webjars/angularjs/1.4.9/angular.min.js"></script>

    <script src="webjars/angularjs/1.4.9/angular-route.min.js"></script>

    <script src="webjars/angularjs/1.4.9/angular-animate.min.js"></script>
    <script src="webjars/angularjs/1.4.9/angular-aria.min.js"></script>
    <script src="webjars/angularjs/1.4.9/angular-animate.min.js"></script>
    <script src="webjars/angularjs/1.4.9/angular-messages.min.js"></script>

    <script src="webjars/angular-material/1.0.5/angular-material.js"></script>

    <script src="webjars/jquery/3.0.0-alpha1/jquery.min.js"></script>

    <script src="webjars/lodash/4.0.0/lodash.min.js"></script>

    <style type="text/css">
        .layout-margin {
            margin: 4px;
        }

        html, body {
            height: 100%;
            margin: 0;
        }

        #wrapper {
            min-height: 100%;
        }
    </style>

    <script type="text/javascript">
        var adminApp = angular.module('adminApp', ['ngMaterial', 'ngRoute', 'ngMessages']);

        adminApp.config(['$routeProvider', function ($routeProvider) {
            $routeProvider.
                    when('/entrypoints', {
                        templateUrl: 'partials/entrypoints.html',
                        controller: 'EntrypointsCtrl'
                    }).
                    when('/add-entrypoint', {
                        templateUrl: 'partials/add-entrypoint.html',
                        controller: 'AddEntrypointCtrl'
                    }).
                    otherwise({
                        redirectTo: '/entrypoints'
                    })
        }]);

        adminApp.factory('PortProvider', ['$http', function ($http) {
            return {
                getPort: function (id) {
                    return $http.get('/api/ports/' + id).then(function (response) {
                        return response.data;
                    });
                }
            }
        }]);

        adminApp.controller('EntrypointsCtrl', ['$scope', '$http', '$interval', function ($scope, $http, $interval) {

            $http({
                method: 'GET',
                url: '/api/entrypoints'
            }).then(function (response) {
                $scope.entrypoints = response.data;
            });

            $scope.loadEntrypoint = function (id) {
                $scope.selectedEntrypoint = id;
            }

        }]);

        adminApp.controller('AddEntrypointCtrl', ['$scope', '$http', '$location', function ($scope, $http, $location) {
            /* Init conf object, avoid undefined inner objects and show expected fields */
            $scope.conf = {
                haproxy: "",
                hapUser: "",
                context: {
                    templateUri: ""
                },
                frontends: [],
                backends: []
            };

            $scope.availableHaproxy = ['default-name'];

            $scope.forbiddenGlobalKeys = ['hap_user', 'syslog_port', 'application', 'plateforme', 'templateUri'];
            $scope.forbiddenFrontendKeys = ['id', 'port'];
            $scope.forbiddenBackendKeys = ['id'];

            $scope.addFrontend = function () {
                $scope.conf.frontends.push({
                    id: "",
                    context: {}
                });
            };

            $scope.removeFrontend = function (frontend) {
                var index = $scope.conf.frontends.indexOf(frontend);
                if (index > -1) {
                    $scope.conf.frontends.splice(index, 1);
                }
            };

            $scope.addBackend = function () {
                $scope.conf.backends.push({
                    id: "",
                    servers: [],
                    context: {}
                });
            };

            $scope.removeBackend = function (backend) {
                var index = $scope.conf.backends.indexOf(backend);
                if (index > -1) {
                    $scope.conf.backends.splice(index, 1);
                }
            };

            $scope.createEntrypoint = function () {
                $http.post('/api/entrypoint/' + $scope.conf.context.application + '/' + $scope.conf.context.plateforme, $scope.conf).then(function (response) {
                    $location.path('/');
                }, function (error) {
                    console.log(error);
                });
            };

        }]);

        adminApp.directive('entrypointConfigurationView', ['PortProvider',
            function (PortProvider) {
                return {
                    restrict: 'E',
                    templateUrl: 'partials/entrypoint-configuration-view.html',
                    scope: {
                        conf: '=conf'
                    },
                    link: function (scope, element, attrs) {
                        scope.globalContextFilter = function (entry, index, array) {
                            //if(entry.$key == 'application' || entry.$key == 'plateforme' || entry.$key == 'templateUri'){
                            //    return false;
                            //}
                            return true;
                        };
                    }
                }
            }
        ]);

        adminApp.directive('contextMap', ['$mdDialog',
            function ($mdDialog) {
                return {
                    restrict: 'E',
                    templateUrl: 'partials/context-map.html',
                    scope: {
                        context: '=context',
                        title: '@'
                    },
                    link: function (scope, element, attrs) {
                        scope.showContext = function () {
                            $mdDialog.show({
                                templateUrl: 'context-map/popup.html',
                                clickOutsideToClose: true,
                                scope: scope,
                                autoWrap: false,
                                openFrom: element,
                                closeTo: element,
                                preserveScope: true,
                                fullscreen: false
                            });
                        }
                    }
                }
            }
        ]);

        adminApp.directive('contextMapInput', [
            function () {
                return {
                    restrict: 'E',
                    templateUrl: 'partials/context-map-input.html',
                    scope: {
                        context: '=context',
                        forbidden: '=?forbidden'
                    },
                    link: function (scope, element, attrs) {

                        if (scope.forbidden == undefined) scope.forbidden = [];
                        scope.chips = [];

                        scope.$watch('context', function (newContext, oldContext) {
                            if (newContext != undefined) {
                                scope.chips = Object.keys(newContext).filter(function (key) {
                                    return scope.forbidden.indexOf(key) == -1;
                                }).sort().map(function (key) {
                                    return {key: key, value: scope.context[key]};
                                });
                            }
                        }, true);

                        var chipsToContext = function () {
                            /* keys provided by some other components should not be disturbed by thoose created by context map input
                             this is why we use angular.extend */
                            scope.context = angular.extend({}, scope.chips.reduce(function (context, chip) {
                                context[chip.key] = chip.value;
                                return context;
                            }, {}), scope.context);
                        };

                        scope.validateContextInput = function (chip) {
                            var keyValue = chip.split(":");
                            if (keyValue.length != 2) return null;
                            var key = keyValue[0];
                            var value = keyValue[1];
                            if (scope.forbidden.indexOf(key) > -1) return null;
                            if (value == '') return null;
                            return {
                                key: key,
                                value: value.trim()
                            }
                        };

                        scope.add = function (item) {
                            chipsToContext();
                        };

                        scope.remove = function (item) {
                            chipsToContext();
                        }

                    }
                }
            }
        ]);

        adminApp.directive('entrypointView', ['$interval', '$timeout', '$http', '$q', 'PortProvider',
            function ($interval, $timeout, $http, $q, PortProvider) {
                return {
                    restrict: 'E',
                    templateUrl: 'partials/entrypoint-view.html',
                    scope: {
                        id: '=id'
                    },
                    link: function (scope, element, attrs) {
                        var reloadDelay = 3000;
                        var blinkingDelay = 3000;
                        var autoRefresh = false;
                        var blinking = false;

                        refreshAllStates = function () {
                            return $q.all({
                                current: $http.get('/api/entrypoint/' + scope.id + '/current')
                                        .then(function (response) {
                                            return portPromises(scope.id, response.data);
                                        }, function (error) {
                                            //TODO Check for 404
                                            scope.current = undefined
                                        }),
                                pending: $http.get('/api/entrypoint/' + scope.id + '/pending')
                                        .then(function (response) {
                                            return portPromises(scope.id, response.data);
                                        }, function (error) {
                                            //TODO Check for 404
                                            scope.pending = undefined
                                        }),
                                committing: $http.get('/api/entrypoint/' + scope.id + '/committing')
                                        .then(function (response) {
                                            return portPromises(scope.id, response.data);
                                        }, function (error) {
                                            //TODO Check for 404
                                            scope.committing = undefined
                                        })
                            }).then(function (values) {
                                scope.current = values.current;
                                scope.pending = values.pending;
                                scope.committing = values.committing;
                            });
                        };

                        var portPromises = function (id, conf) {
                            var promises = [].concat(conf.frontends.map(function (frontend) {
                                return PortProvider.getPort(id + '-' + frontend.id).then(function (port) {
                                    frontend.port = port;
                                });
                            }));
                            promises.push(PortProvider.getPort(id + '-syslog').then(function (port) {
                                conf.syslogPort = port;
                            }));
                            return $q.all(promises).then(function () {
                                return conf;
                            });
                        };


                        /* When id is changed, we must reload the data */
                        scope.$watch('id', function (newValue, oldValue) {
                            autoRefresh = false;
                            blinking = false;
                            refreshAllStates().then(function () {
                                autoRefresh = true;
                                blinking = true;
                            });
                        });

                        var refreshAuto = $interval(function () {
                            if (scope.id && autoRefresh) {
                                refreshAllStates();
                            }
                        }, reloadDelay);

                        /* Make tab blink while something is committing */
                        scope.$watch('committing', function (newValue, oldValue) {
                            if (blinking) {
                                scope.commitBlink = (newValue != undefined);
                            }
                        }, true);

                        /* Make tab blink several seconds when new pending */
                        scope.$watch('pending', function (newValue, oldValue) {
                            if (blinking) {
                                scope.pendingBlink = true;
                                $timeout(function () {
                                    scope.pendingBlink = false;
                                }, blinkingDelay);
                            }
                        }, true);

                        /* Make tab blink several seconds when new current */
                        scope.$watch('current', function (newValue, oldValue) {
                            if (blinking) {
                                scope.currentBlink = true;
                                $timeout(function () {
                                    scope.currentBlink = false;
                                }, blinkingDelay);
                            }
                        }, true);

                        scope.$on('$destroy', function () {
                            $interval.cancel(refreshAuto);
                        });
                    }
                }
            }]);

    </script>
</head>
<body>
<div id="wrapper" layout="column">
    <div>
        <md-content>
            <md-toolbar>
                <div class="md-toolbar-tools">
                    <h2>
                        <span>HAProxy As A Service</span>
                    </h2>
                    <md-button class="md-raised md-warn md-hue-2" ng-href="/#/add-entrypoint">
                        Ajouter un entrypoint
                    </md-button>
                </div>
            </md-toolbar>
        </md-content>
    </div>
    <div ng-view layout flex>
    </div>
    <div>
        <md-content>
            <md-toolbar>
                <div class="md-toolbar-tools">
                </div>
            </md-toolbar>
        </md-content>
    </div>
</div>
</body>
</html>